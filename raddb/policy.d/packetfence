# packetfence-local-auth
# Try to get the Cleartext-Password from any of the pfguest, pfsponsor or pfsms
# databases.
# If this fails, the mschap module will try to authenticate using ntlm_auth.

packetfence-local-auth { 
    ####Activate local user eap authentication based on a specific SSID ####
    if (Called-Station-SSID == "%{redis:get FR:CONFIG:LOCAL_AUTH:SSID}") {
    # Disable ntlm_auth
        update control {
            &MS-CHAP-Use-NTLM-Auth := No
        }
    # Check password table for local user
        pflocal
        if (fail || notfound) {
    # Check password table with email and password for a sponsor registration
            pfguest
            if (fail || notfound) {
    # Check password table with email and password for a guest registration
                pfsponsor
                if (fail || notfound) {
    # Check activation table with phone number and PIN code 
                    pfsms
                    if (fail || notfound) {
                        update control {
                           &MS-CHAP-Use-NTLM-Auth := Yes
                        }
                    }
                }
            }
        }
    }

}
### END Local SQL authentication
packetfence-switch-access { 
    if ( \
        ( &Service-Type ==  "NAS-Prompt-User") && \
        ( &NAS-Port-Type == "Virtual" || &NAS-Port-Type == "Async") ) {
            rest-switch-access  
    }
    
}

request-timing {
    if (reply:PacketFence-Request-Time != 0) {
        update control {
            &PacketFence-Request-Time := "%{expr: %{reply:PacketFence-Request-Time} - %{control:Tmp-Integer-0}}"
        }
    }
}

copy_to_control {

if (&reply:PacketFence-Switch-Id) {
    update control {
        &PacketFence-Switch-Id := &reply:PacketFence-Switch-Id
    }
}
if (&reply:PacketFence-IsPhone) {
    update control {
        &PacketFence-IsPhone := &reply:PacketFence-IsPhone
    }
}
if (&reply:PacketFence-IfIndex) {
    update control {
        &PacketFence-IfIndex := &reply:PacketFence-IfIndex
    }
}
if (&reply:PacketFence-Computer-Name) {
    update control {
        &PacketFence-Computer-Name := &reply:PacketFence-Computer-Name
    }
}
if (&reply:PacketFence-Role) {
    update control {
        &PacketFence-Role := &reply:PacketFence-Role
    }
}
if (&reply:PacketFence-Status) {
    update control {
        &PacketFence-Status := &reply:PacketFence-Status
    }
}
if (&reply:PacketFence-Switch-Ip-Address) {
    update control {
        &PacketFence-Switch-Ip-Address := &reply:PacketFence-Switch-Ip-Address
    }
}
if (&reply:PacketFence-AutoReg) {
    update control {
        &PacketFence-AutoReg := &reply:PacketFence-AutoReg
    }
}
if (&reply:PacketFence-Connection-Type) {
    update control {
        &PacketFence-Connection-Type := &reply:PacketFence-Connection-Type
    }
}
if (&reply:PacketFence-Switch-Mac) {
    update control {
        &PacketFence-Switch-Mac := &reply:PacketFence-Switch-Mac
    }
}
if (&reply:PacketFence-Mac) {
    update control {
        &PacketFence-Mac := &reply:PacketFence-Mac
    }
}
if (&reply:PacketFence-UserName) {
    update control {
        &PacketFence-UserName := &reply:PacketFence-UserName
    }
}
if (&reply:PacketFence-Eap-Type) {
    update control {
        &PacketFence-Eap-Type := &reply:PacketFence-Eap-Type
    }
}
}
