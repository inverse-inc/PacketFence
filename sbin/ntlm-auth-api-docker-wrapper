#!/bin/bash

source /usr/local/pf/containers/systemd-service

name=ntlm-auth-api

conf_dir="/usr/local/pf/var/conf/${name}.d/"
env_files=$(ls $conf_dir 2>/dev/null)
option=$1
check_interval=5

if [ -z "$env_files" ]; then
    echo "No domain config exists. Nothing to do."
    exit 0
fi

if [ "$option" == "" ]; then
    echo "No option given, terminated"
    exit 1
fi

if [ "$option" = "start" ]; then
    for env_file in $env_files; do
        iden=$(echo $env_file | awk -F '.' '{print $1}')
        echo "starting ntlm auth api domain service for: $iden using env file: $env_file"
        systemctl start packetfence-ntlm-auth-api-domain@"$iden"
    done
    sleep 5

    while true; do
        running_containers=$(docker ps --format "{{.Names}}" | grep ntlm-auth-api)

        for env_file in $env_files; do
            iden=$(echo $env_file | awk -F '.' '{print $1}')
            expected_container="ntlm-auth-api-$iden"

            ok="n"
            for running_container in $running_containers; do
                if [ "$running_container" == "$expected_container" ]; then
                    ok="y"
                fi
            done
            if [ $ok == "n" ]; then
                echo "probing $expected_container failed."
                exit 1
            fi
        done
        sleep $check_interval
    done
elif [ "$option" = "stop" ]; then
    for env_file in $env_files; do
        iden=$(echo $env_file | awk -F '.' '{print $1}')
        echo "stopping ntlm auth api domain service for: $iden"
        systemctl stop packetfence-ntlm-auth-api-domain@"$iden"
    done
    echo "stopped"
    sleep 1
fi
